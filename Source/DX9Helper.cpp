/*
* (C) 2019 see Authors.txt
*
* This file is part of MPC-BE.
*
* MPC-BE is free software; you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation; either version 3 of the License, or
* (at your option) any later version.
*
* MPC-BE is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*
*/

#pragma once

#include "stdafx.h"
#include <d3d9.h>
#include "Helper.h"
#include "DX9Helper.h"

UINT GetAdapter(HWND hWnd, IDirect3D9Ex* pD3D)
{
	CheckPointer(hWnd, D3DADAPTER_DEFAULT);
	CheckPointer(pD3D, D3DADAPTER_DEFAULT);

	const HMONITOR hMonitor = MonitorFromWindow(hWnd, MONITOR_DEFAULTTONEAREST);
	CheckPointer(hMonitor, D3DADAPTER_DEFAULT);

	for (UINT adp = 0, num_adp = pD3D->GetAdapterCount(); adp < num_adp; ++adp) {
		const HMONITOR hAdapterMonitor = pD3D->GetAdapterMonitor(adp);
		if (hAdapterMonitor == hMonitor) {
			return adp;
		}
	}

	return D3DADAPTER_DEFAULT;
}

HRESULT Dump4ByteSurface(IDirect3DSurface9* pSurface, const wchar_t* filename)
{
	D3DSURFACE_DESC desc;
	HRESULT hr = pSurface->GetDesc(&desc);

	if (SUCCEEDED(hr) && (desc.Format == D3DFMT_A8R8G8B8 || desc.Format == D3DFMT_X8R8G8B8 || desc.Format == D3DFMT_AYUV)) {
		CComPtr<IDirect3DSurface9> pSurfaceShared;

		if (desc.Pool == D3DPOOL_DEFAULT) {
			IDirect3DDevice9* pDevice;
			pSurface->GetDevice(&pDevice);
			hr = pDevice->CreateOffscreenPlainSurface(desc.Width, desc.Height, desc.Format, D3DPOOL_SYSTEMMEM, &pSurfaceShared, nullptr);
			if (SUCCEEDED(hr)) {
				hr = pDevice->GetRenderTargetData(pSurface, pSurfaceShared);
			}
			pDevice->Release();
		} else {
			pSurfaceShared = pSurface;
		}

		if (SUCCEEDED(hr)) {
			D3DLOCKED_RECT lr;
			hr = pSurfaceShared->LockRect(&lr, nullptr, D3DLOCK_READONLY);

			if (SUCCEEDED(hr)) {
				hr = SaveARGB32toBMP((BYTE*)lr.pBits, lr.Pitch, desc.Width, desc.Height, filename);
				pSurfaceShared->UnlockRect();
			}
		}
	}

	return hr;
}
